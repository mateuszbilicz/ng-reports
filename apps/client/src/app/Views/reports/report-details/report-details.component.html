<div class="card p-3 surface-card shadow-2 border-round">
    <p-toast></p-toast>
    <p-confirmDialog></p-confirmDialog>

    <div *ngIf="report()" class="mb-4">
        <div class="flex justify-content-between align-items-start mb-3">
            <div>
                <h2 class="m-0 text-900">{{ report()!.title }}</h2>
                <div class="flex align-items-center gap-2 mt-2">
                    <p-tag [value]="report()!.severity" [severity]="getSeverityColor(report()!.severity)"></p-tag>
                    <p-tag [value]="report()!.fixed ? 'Fixed' : 'Open'"
                        [severity]="report()!.fixed ? 'success' : 'danger'"></p-tag>
                    <span class="text-500 text-sm ml-2">ID: {{ report()!.id }}</span>
                </div>
            </div>
            <div class="flex gap-2">
                <p-button label="Edit Report" icon="pi pi-pencil" styleClass="p-button-outlined"
                    (onClick)="editReport()"></p-button>
                <p-button label="Back" icon="pi pi-arrow-left" styleClass="p-button-secondary p-button-text"
                    (onClick)="goBack()"></p-button>
            </div>
        </div>

        <div class="surface-ground p-3 border-round mb-3">
            <h4 class="m-0 mb-2">Details</h4>
            <p class="white-space-pre-wrap m-0">{{ report()!.details || 'No details provided.' }}</p>
        </div>
    </div>

    <div class="card p-0 border-none">
        <h3 class="m-0 mb-3 text-800">Comments</h3>

        <div class="flex flex-column gap-3 mb-4">
            @for (comment of comments(); track comment.commentId) {
            <div class="surface-ground p-3 border-round">
                <div class="flex justify-content-between align-items-center mb-2">
                    <div class="flex align-items-center gap-2">
                        <span class="font-bold">{{ comment.author.name || 'Anonymous' }}</span>
                        <span class="text-500 text-sm">{{ comment.date | date:'medium' }}</span>
                    </div>
                    <div class="flex gap-1">
                        <button pButton icon="pi pi-pencil" class="p-button-text p-button-warning p-button-sm"
                            (click)="editComment(comment)"></button>
                        <button pButton icon="pi pi-trash" class="p-button-text p-button-danger p-button-sm"
                            (click)="deleteComment(comment)"></button>
                    </div>
                </div>
                <p class="m-0">{{ comment.content }}</p>
            </div>
            }
            @if (comments().length === 0) {
            <p class="text-500 text-center">No comments yet.</p>
            }
        </div>

        <div class="flex gap-2 align-items-start">
            <textarea pInputTextarea [(ngModel)]="newCommentText" rows="2" class="w-full"
                placeholder="Write a comment..."></textarea>
            <p-button icon="pi pi-send" (onClick)="postComment()" [disabled]="!newCommentText"></p-button>
        </div>
    </div>

    <!-- Report Edit Dialog -->
    <p-dialog [(visible)]="reportDialog" [style]="{ width: '450px' }" header="Edit Report" [modal]="true"
        styleClass="p-fluid">
        <ng-template pTemplate="content">
            <form [formGroup]="reportForm" class="flex flex-column gap-3 mt-3">
                <div class="field">
                    <label for="title">Title</label>
                    <input type="text" pInputText id="title" formControlName="title" />
                </div>
                <div class="field">
                    <label for="description">Details</label>
                    <textarea pInputTextarea id="description" formControlName="description" rows="5"></textarea>
                </div>
                <div class="field">
                    <label for="severity">Severity</label>
                    <p-select [options]="severities" formControlName="severity" appendTo="body" optionLabel="label"
                        optionValue="value"></p-select>
                </div>
                <div class="field-checkbox">
                    <p-checkbox formControlName="fixed" [binary]="true" inputId="fixed"></p-checkbox>
                    <label for="fixed">Fixed</label>
                </div>
            </form>
        </ng-template>
        <ng-template pTemplate="footer">
            <p-button label="Cancel" icon="pi pi-times" styleClass="p-button-text"
                (onClick)="reportDialog = false"></p-button>
            <p-button label="Save" icon="pi pi-check" styleClass="p-button-text" (onClick)="saveReport()"
                [disabled]="reportForm.invalid"></p-button>
        </ng-template>
    </p-dialog>

    <!-- Comment Edit Dialog -->
    <p-dialog [(visible)]="commentEditDialog" [style]="{ width: '450px' }" header="Edit Comment" [modal]="true"
        styleClass="p-fluid">
        <ng-template pTemplate="content">
            <div class="field mt-3">
                <label for="editCommentText">Content</label>
                <textarea pInputTextarea id="editCommentText" [(ngModel)]="editingCommentText" rows="3"></textarea>
            </div>
        </ng-template>
        <ng-template pTemplate="footer">
            <p-button label="Cancel" icon="pi pi-times" styleClass="p-button-text"
                (onClick)="commentEditDialog = false"></p-button>
            <p-button label="Save" icon="pi pi-check" styleClass="p-button-text" (onClick)="saveCommentUpdate()"
                [disabled]="!editingCommentText"></p-button>
        </ng-template>
    </p-dialog>
</div>