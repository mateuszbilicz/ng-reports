<div class="card p-3 surface-card shadow-2 border-round">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center mb-3 gap-2">
    <h2 class="m-0 text-900">Reports</h2>
    <div class="flex gap-2 align-items-center">
      <p-treeSelect class="w-20rem" containerStyleClass="w-full" [(ngModel)]="selectedNode" [options]="nodes()"
                    placeholder="Select Environment" selectionMode="single" (onNodeSelect)="onNodeSelect($event)">
        <ng-template pTemplate="value" let-node>
          @if (selectedNode) {
            {{ selectedNode.data.projectName }} > {{ selectedNode.label }}
          } @else {
            Select Environment
          }
        </ng-template>
      </p-treeSelect>
      <span class="p-input-icon-left">
        <p-iconField iconPosition="left">
          <p-inputIcon styleClass="pi pi-search"/>
          <input type="text" pInputText placeholder="Search..."
                 (input)="dt.filterGlobal($any($event.target).value, 'contains')"/>
        </p-iconField>
      </span>
      <p-button icon="pi pi-refresh" (onClick)="loadReports(currentEnvIdForList)"
                styleClass="p-button-outlined p-button-secondary" pTooltip="Refresh"/>
      <p-button label="New Report" icon="pi pi-plus" (onClick)="openNew()" styleClass="p-button-primary"/>
    </div>
  </div>

  <p-table #dt [value]="reports()" [tableStyle]="{ 'min-width': '60rem' }"
           [globalFilterFields]="['title', 'details', 'status']">
    <ng-template pTemplate="header">
      <tr>
        <th>Title</th>
        <th>Severity</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-report>
      <tr>
        <td>{{ report.title }}</td>
        <td>
          <p-tag [value]="getSeverityText(report.severity)" [severity]="getSeverityColor(report.severity)"></p-tag>
        </td>
        <td>
          <i class="pi"
             [ngClass]="{'pi-check-circle text-green-500': report.isFixed, 'pi-times-circle text-red-500': !report.isFixed}"></i>
          {{ report.isFixed ? 'Fixed' : 'Open' }}
        </td>
        <td>
          <p-button icon="pi pi-pencil" styleClass="p-button-text p-button-warning"
                    (onClick)="editReport(report)" pTooltip="Edit"/>
          <p-button icon="pi pi-trash" styleClass="p-button-text p-button-danger"
                    (onClick)="deleteReport(report)" pTooltip="Delete"/>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <p-dialog [(visible)]="reportDialog" [style]="{ width: '450px' }" header="Report Details" [modal]="true"
            styleClass="p-fluid">
    <ng-template pTemplate="content">
      <form [formGroup]="reportForm" class="flex flex-column gap-3 mt-3">

        <div class="field">
          <label for="title">Title</label>
          <input type="text" pInputText id="title" formControlName="title"/>
        </div>

        <div class="field">
          <label for="description">Description (Details)</label>
          <textarea pInputTextarea id="description" formControlName="description" rows="3"></textarea>
        </div>

        <div class="field">
          <label for="severity">Severity</label>
          <p-select [options]="severities" formControlName="severity" appendTo="body" optionLabel="label"
                    optionValue="value"/>
        </div>

        <div class="field">
          <label for="environmentId">Environment ID (Required for Creation)</label>
          <input type="text" pInputText id="environmentId" formControlName="environmentId"
                 [readonly]="isEditMode"/>
        </div>

      </form>
    </ng-template>

    <ng-template pTemplate="footer">
      <p-button label="Cancel" icon="pi pi-times" styleClass="p-button-text" (onClick)="hideDialog()"></p-button>
      <p-button label="Save" icon="pi pi-check" styleClass="p-button-text" (onClick)="saveReport()"
                [disabled]="reportForm.invalid"></p-button>
    </ng-template>
  </p-dialog>
</div>
